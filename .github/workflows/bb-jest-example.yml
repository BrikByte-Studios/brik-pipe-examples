name: Phase 0 â€” Jest Adapter Integration

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  jest-example:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------
      # Checkout examples repo (this repo)
      # --------------------------------------------
      - name: Checkout brik-pipe-examples
        uses: actions/checkout@v4

      # --------------------------------------------
      # Checkout CLI repo (private)
      # --------------------------------------------
      - name: Checkout brikbyteos-cli
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/brikbyteos-cli
          path: brikbyteos-cli
          token: ${{ secrets.BRIKBYTE_REPO_READ_TOKEN }}

      # --------------------------------------------
      # Setup Go (for building bb)
      # --------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      # --------------------------------------------
      # Setup Node (for Jest example)
      # --------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: examples/node-jest-basic/package-lock.json

      # --------------------------------------------
      # Install example dependencies.
      # --------------------------------------------
      - name: Install deps (jest example)
        working-directory: examples/node-jest-basic
        run: npm ci

      # --------------------------------------------
      # Build bb CLI
      # --------------------------------------------
      - name: Build bb CLI
        working-directory: brikbyteos-cli
        run: |
          make build

      - name: Debug paths
        run: |
          pwd
          ls -la
          ls -la brikbyteos-cli || true
          ls -la examples/node-jest-basic || true

      # --------------------------------------------
      # Run bb test
      # --------------------------------------------
      - name: Run bb test (Jest adapter)
        working-directory: examples/node-jest-basic
        run: |
          "${GITHUB_WORKSPACE}/brikbyteos-cli/bb" test \
            --config bb.yaml \
            --out .bb/artifacts

      # --------------------------------------------
      # Validate artifact structure (Phase 0 contract)
      # --------------------------------------------
      - name: Validate artifact contract
        working-directory: examples/node-jest-basic
        run: |
          test -f .bb/artifacts/raw/unit-jest/reports/jest-results.json || (echo "Missing Jest report" && exit 1)
          test -f .bb/artifacts/raw/unit-jest/logs/stdout.log || (echo "Missing stdout log" && exit 1)
          test -f .bb/artifacts/raw/unit-jest/logs/stderr.log || (echo "Missing stderr log" && exit 1)
          test -f .bb/artifacts/bb-results.json || (echo "Missing bb-results.json" && exit 1)

      # --------------------------------------------
      # Schema sanity check (Phase 0 minimal validation)
      # Replace with strict validator when available
      # --------------------------------------------
      - name: Validate bb-results.json (structural)
        working-directory: examples/node-jest-basic
        run: |
          node -e "
            const fs=require('fs');
            const j=JSON.parse(fs.readFileSync('.bb/artifacts/bb-results.json','utf8'));
            if(!j) process.exit(1);
            console.log('bb-results.json parsed OK');
          "

      # --------------------------------------------
      # Upload artifacts for traceability
      # --------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bb-phase0-jest-artifacts
          path: examples/node-jest-basic/.bb/artifacts